{% load static %}
<!DOCTYPE html>
<html lang="en" class="light">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WaveHeaven Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: {
                            DEFAULT: '#3b82f6',
                            dark: '#60a5fa',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        /* Custom styles for equalizer */
        .eq-container {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            height: 250px;
            padding: 20px;
            background: rgba(59, 130, 246, 0.05);
            border-radius: 12px;
            position: relative;
        }

        .eq-band {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 18%;
            height: 100%;
            position: relative;
        }

        .eq-slider-container {
            height: 180px;
            width: 100%;
            background: rgba(59, 130, 246, 0.1);
            border-radius: 12px;
            position: relative;
            overflow: hidden;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .eq-slider {
            -webkit-appearance: none;
            appearance: none;
            width: 180px;
            height: 40px;
            background: transparent;
            outline: none;
            transform: rotate(-90deg) translateY(-70px);
            transform-origin: center;
            position: absolute;
            top: 50%;
            left: 50%;
            margin-left: -90px;
            margin-top: -20px;
        }

        .eq-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #3b82f6;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            border: 2px solid white;
            transition: all 0.2s ease;
        }

        .eq-slider::-webkit-slider-thumb:hover {
            background: #2563eb;
            transform: scale(1.1);
        }

        .eq-slider::-webkit-slider-runnable-track {
            width: 100%;
            height: 8px;
            cursor: pointer;
            background: #e2e8f0;
            border-radius: 4px;
        }

        .dark .eq-slider::-webkit-slider-runnable-track {
            background: #374151;
        }

        .dark .eq-slider::-webkit-slider-thumb {
            background: #60a5fa;
            border: 2px solid #1f2937;
        }

        .eq-level {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to top, #3b82f6, #60a5fa);
            border-radius: 8px;
            transition: height 0.3s ease;
        }

        .dark .eq-level {
            background: linear-gradient(to top, #60a5fa, #93c5fd);
        }

        .eq-value {
            font-size: 0.875rem;
            font-weight: 600;
            color: #3b82f6;
            margin-top: 8px;
            min-height: 1.5rem;
        }

        .dark .eq-value {
            color: #60a5fa;
        }

        .eq-freq {
            font-size: 0.875rem;
            font-weight: 500;
            margin-top: 8px;
        }

        .eq-grid-lines {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
        }

        .eq-grid-line {
            position: absolute;
            left: 0;
            right: 0;
            height: 1px;
            background: rgba(203, 213, 225, 0.5);
        }

        .dark .eq-grid-line {
            background: rgba(75, 85, 99, 0.5);
        }

        .eq-grid-label {
            position: absolute;
            left: -30px;
            font-size: 0.7rem;
            color: #94a3b8;
        }

        .dark .eq-grid-label {
            color: #64748b;
        }

        /* Preset buttons */
        .preset-btn {
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
        }

        .preset-btn::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 5px;
            height: 5px;
            background: rgba(255, 255, 255, 0.5);
            opacity: 0;
            border-radius: 100%;
            transform: scale(1, 1) translate(-50%, -50%);
            transform-origin: 50% 50%;
        }

        .preset-btn:hover::after {
            animation: ripple 1s ease-out;
        }

        @keyframes ripple {
            0% {
                transform: scale(0, 0);
                opacity: 0.5;
            }

            100% {
                transform: scale(20, 20);
                opacity: 0;
            }
        }
    </style>
</head>

<body
    class="flex flex-col min-h-screen bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100 transition-colors duration-200">

    <!-- Header -->
    <header class="px-4 lg:px-6 h-14 flex items-center border-b">
        <a href="/" class="flex items-center justify-center">
            <i data-lucide="audio-waveform" class="h-6 w-6 text-blue-600 dark:text-blue-400"></i>
            <span
                class="ml-2 text-lg font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-500 to-purple-500">
                WaveHeaven
            </span>
        </a>
        <nav class="ml-auto flex gap-4 sm:gap-6">
            <a href="{% url 'profiles_page' %}" class="text-sm font-medium hover:underline underline-offset-4">Sound
                Profiles</a>
            <a href="{% url 'user_statistics' %}"
                class="text-sm font-medium hover:underline underline-offset-4">Statistics</a>
            <a href="{% url 'hearing_test' %}" class="text-sm font-medium hover:underline underline-offset-4">Hearing
                Test</a>
            <button id="darkModeToggle" class="text-sm font-medium hover:underline underline-offset-4">
                <i data-lucide="sun" class="h-5 w-5 dark:hidden"></i>
                <i data-lucide="moon" class="h-5 w-5 hidden dark:inline"></i>
                <span class="sr-only">Toggle mode</span>
            </button>
            <a href="{% url 'logout' %}"
                class="text-sm font-medium text-red-500 hover:underline underline-offset-4">Logout</a>
        </nav>
    </header>

    <!-- Main Content -->
    <main class="flex-1 p-6">
        <div class="max-w-4xl mx-auto">
            <h1 class="text-3xl font-bold text-center mb-8">Welcome to WaveHeaven</h1>
            <p class="text-center text-gray-500 dark:text-gray-400 mb-12">
                Your personalized sound experience starts here.
            </p>

            <!-- Feature Boxes -->
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-6 mb-12">
                <a href="{% url 'profiles_page' %}"
                    class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md text-center hover:bg-gray-100 dark:hover:bg-gray-700 transition">
                    <i data-lucide="music" class="h-10 w-10 mx-auto text-blue-600 dark:text-blue-400"></i>
                    <h3 class="text-lg font-semibold mt-4">Sound Profiles</h3>
                    <p class="text-gray-500 dark:text-gray-400">Manage your personalized sound profiles.</p>
                </a>
                <a href="{% url 'user_statistics' %}"
                    class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md text-center hover:bg-gray-100 dark:hover:bg-gray-700 transition">
                    <i data-lucide="bar-chart" class="h-10 w-10 mx-auto text-green-600 dark:text-green-400"></i>
                    <h3 class="text-lg font-semibold mt-4">Statistics</h3>
                    <p class="text-gray-500 dark:text-gray-400">View your personalized listening insights.</p>
                </a>
                <a href="{% url 'hearing_test' %}"
                    class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md text-center hover:bg-gray-100 dark:hover:bg-gray-700 transition">
                    <i data-lucide="ear" class="h-10 w-10 mx-auto text-orange-600 dark:text-orange-400"></i>
                    <h3 class="text-lg font-semibold mt-4">Hearing Test</h3>
                    <p class="text-gray-500 dark:text-gray-400">Take a hearing test and adjust your settings.</p>
                </a>
            </div>

            <!-- Audio Capture & Automatic Adjustment -->
            <section id="audio-control" class="mt-12">
                <h2 class="text-2xl font-semibold text-center mb-4">Try WaveHeaven</h2>
                <p class="text-center text-gray-500 dark:text-gray-400 mb-6">
                    Experience real-time automatic volume adjustment.
                </p>

                <div class="flex flex-col items-center space-y-4">
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md w-full">
                        <p id="ambientVolumeDisplay" class="text-xl font-semibold text-center mb-4">Ambient Volume: --
                        </p>
                        <div class="flex justify-center space-x-4 mb-6">
                            <button onclick="startListening()"
                                class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition flex items-center">
                                <i data-lucide="mic" class="mr-2 h-4 w-4"></i>
                                Activate Microphone
                            </button>
                            <button onclick="stopListening()"
                                class="px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 rounded-md hover:bg-gray-300 dark:hover:bg-gray-600 transition flex items-center">
                                <i data-lucide="mic-off" class="mr-2 h-4 w-4"></i>
                                Deactivate Microphone
                            </button>
                        </div>
                        <div class="flex items-center justify-center mb-4">
                            <div class="w-full max-w-md bg-gray-200 dark:bg-gray-700 rounded-full h-4 overflow-hidden">
                                <div id="volumeIndicator"
                                    class="bg-blue-600 h-4 rounded-full transition-all duration-300" style="width: 50%">
                                </div>
                            </div>
                        </div>
                        <p class="text-lg text-center">Tab Volume: <span id="tabVolumeDisplay"
                                class="font-semibold">100%</span></p>
                        <p id="exposureTimeDisplay" class="text-lg text-center">Exposure Time: <span class="font-semibold">0 minutes</span></p>
                    </div>

                    <!-- Enhanced Equalizer Section -->
                    <section id="equalizer" class="w-full bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-semibold">Equalizer</h2>
                            <div class="flex space-x-2">
                                <button onclick="applyPreset('flat')"
                                    class="preset-btn px-3 py-1 text-sm bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 rounded-md hover:bg-gray-300 dark:hover:bg-gray-600 transition">
                                    Flat
                                </button>
                                <button onclick="applyPreset('bass')"
                                    class="preset-btn px-3 py-1 text-sm bg-blue-100 dark:bg-blue-900/50 text-blue-800 dark:text-blue-200 rounded-md hover:bg-blue-200 dark:hover:bg-blue-800 transition">
                                    Bass Boost
                                </button>
                                <button onclick="applyPreset('vocal')"
                                    class="preset-btn px-3 py-1 text-sm bg-purple-100 dark:bg-purple-900/50 text-purple-800 dark:text-purple-200 rounded-md hover:bg-purple-200 dark:hover:bg-purple-800 transition">
                                    Vocal Clarity
                                </button>
                                <button onclick="applyPreset('treble')"
                                    class="preset-btn px-3 py-1 text-sm bg-green-100 dark:bg-green-900/50 text-green-800 dark:text-green-200 rounded-md hover:bg-green-200 dark:hover:bg-green-800 transition">
                                    Treble Boost
                                </button>
                            </div>
                        </div>

                        <div class="eq-container">
                            <!-- Grid lines for reference -->
                            <div class="eq-grid-lines">
                                <div class="eq-grid-line" style="top: 25%;">
                                    <span class="eq-grid-label">+15dB</span>
                                </div>
                                <div class="eq-grid-line" style="top: 50%;">
                                    <span class="eq-grid-label">0dB</span>
                                </div>
                                <div class="eq-grid-line" style="top: 75%;">
                                    <span class="eq-grid-label">-15dB</span>
                                </div>
                            </div>

                            <!-- 60Hz Band -->
                            <div class="eq-band" data-freq="60">
                                <div class="eq-slider-container">
                                    <div class="eq-level" id="eq-level-60" style="height: 50%;"></div>
                                    <input type="range" id="eq60" class="eq-slider" min="-30" max="30" value="0"
                                        step="1" oninput="updateEqualizer(60, this.value)">
                                </div>
                                <div class="eq-value" id="eq-value-60">0 dB</div>
                                <div class="eq-freq">60Hz</div>
                            </div>

                            <!-- 250Hz Band -->
                            <div class="eq-band" data-freq="250">
                                <div class="eq-slider-container">
                                    <div class="eq-level" id="eq-level-250" style="height: 50%;"></div>
                                    <input type="range" id="eq250" class="eq-slider" min="-30" max="30" value="0"
                                        step="1" oninput="updateEqualizer(250, this.value)">
                                </div>
                                <div class="eq-value" id="eq-value-250">0 dB</div>
                                <div class="eq-freq">250Hz</div>
                            </div>

                            <!-- 1kHz Band -->
                            <div class="eq-band" data-freq="1000">
                                <div class="eq-slider-container">
                                    <div class="eq-level" id="eq-level-1000" style="height: 50%;"></div>
                                    <input type="range" id="eq1000" class="eq-slider" min="-30" max="30" value="0"
                                        step="1" oninput="updateEqualizer(1000, this.value)">
                                </div>
                                <div class="eq-value" id="eq-value-1000">0 dB</div>
                                <div class="eq-freq">1kHz</div>
                            </div>

                            <!-- 4kHz Band -->
                            <div class="eq-band" data-freq="4000">
                                <div class="eq-slider-container">
                                    <div class="eq-level" id="eq-level-4000" style="height: 50%;"></div>
                                    <input type="range" id="eq4000" class="eq-slider" min="-30" max="30" value="0"
                                        step="1" oninput="updateEqualizer(4000, this.value)">
                                </div>
                                <div class="eq-value" id="eq-value-4000">0 dB</div>
                                <div class="eq-freq">4kHz</div>
                            </div>

                            <!-- 16kHz Band -->
                            <div class="eq-band" data-freq="16000">
                                <div class="eq-slider-container">
                                    <div class="eq-level" id="eq-level-16000" style="height: 50%;"></div>
                                    <input type="range" id="eq16000" class="eq-slider" min="-30" max="30" value="0"
                                        step="1" oninput="updateEqualizer(16000, this.value)">
                                </div>
                                <div class="eq-value" id="eq-value-16000">0 dB</div>
                                <div class="eq-freq">16kHz</div>
                            </div>
                        </div>

                        <div class="mt-6">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-sm font-medium">Master Volume</span>
                                <span class="text-sm font-medium" id="masterVolumeValue">100%</span>
                            </div>
                            <input type="range" id="masterVolume" min="0" max="100" value="100" step="1"
                                class="w-full h-2 bg-gray-200 dark:bg-gray-700 rounded-full appearance-none cursor-pointer"
                                oninput="updateMasterVolume(this.value)">
                        </div>
                    </section>

                    <!-- Sound Profile Selection -->
                    <div class="w-full bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md mt-6">
                        <h3 class="text-lg font-semibold mb-4">Sound Profile</h3>
                        <div class="flex flex-col sm:flex-row sm:items-center gap-4">
                            <div class="flex-1">
                                <label for="soundProfile" class="block text-sm font-medium mb-2">Select a Sound
                                    Profile:</label>
                                <select id="soundProfile"
                                    class="w-full px-4 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md">
                                    {% for profile in user_prefs.audio_profiles %}
                                    <option value="{{ profile.name }}">{{ profile.name }}</option>
                                    {% empty %}
                                    <option disabled>No sound profiles available</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <button onclick="applySoundProfile()"
                                class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition flex items-center justify-center">
                                <i data-lucide="check" class="h-4 w-4 mr-2"></i>
                                Apply Profile
                            </button>
                        </div>
                    </div>

                    <!-- Hidden audio element -->
                    <audio id="audioElement" src="your-audio-file.mp3" style="display:none;" controls></audio>
                </div>
            </section>
        </div>
    </main>

    <footer class="flex flex-col gap-2 sm:flex-row py-6 w-full shrink-0 items-center px-4 md:px-6 border-t">
        <p class="text-xs text-gray-500 dark:text-gray-400">© 2025 WaveHeaven. All rights reserved.</p>
        <nav class="sm:ml-auto flex gap-4 sm:gap-6">
            <a class="text-xs hover:underline underline-offset-4" href="#">Terms of Service</a>
            <a class="text-xs hover:underline underline-offset-4" href="#">Privacy Policy</a>
        </nav>
    </footer>

    <script>
        // Initialize Lucide icons
        lucide.createIcons();
    
        // Variables for audio processing
        let audioContext;
        let analyser;
        let microphone;
        let dataArray;
        let isListening = false;
        let ambientVolumeDisplay = document.getElementById("ambientVolumeDisplay");
        let activeTabId = null;
        let globalAudioContext = new (window.AudioContext || window.webkitAudioContext)();
        let gainNode = globalAudioContext.createGain(); // Volume controller
        let sourceNode = globalAudioContext.createGain(); // Volume controller
        let exposureStartTime = null;
        let exposureTime = 0; // Tiempo de exposición acumulado en milisegundos
        let exposureThreshold = 5 * 1000; // 5 seconds in milliseconds (just to test later it should be 10 minutes)
        let warningTriggered = false;
        let eqFilters = [];
    
        const frequencies = [60, 250, 1000, 4000, 16000];
    
        const selectSoundProfile = document.querySelector("#soundProfile");
    
        selectSoundProfile.addEventListener("change", function (e) {
            e.preventDefault();
            e.stopImmediatePropagation();
            // updateEqualizer();
        });
    
        // Initialize equalizer
        setupEqualizer();
        filledSoundProfile();
    
        // Function to get filled sound profile
        async function filledSoundProfile() {
            try {
                const response = await fetch('/list_profiles/');
                const data = await response.json();
                const selectElement = document.getElementById("soundProfile");
    
                // Limpiar opciones previas
                selectElement.innerHTML = "";
    
                if (data.profiles.length === 0) {
                    selectElement.innerHTML = `<option disabled>No sound profiles available</option>`;
                    return;
                }
    
                data.profiles.forEach(profile => {
                    let option = document.createElement("option");
                    option.value = profile.name;
                    option.textContent = profile.name;
                    selectElement.appendChild(option);
                });
    
                // Aplicar automáticamente el primer perfil si está disponible
                if (data.profiles.length > 0) {
                    applySoundProfile(data.profiles[0].name);
                }
    
            } catch (error) {
                console.error("Error loading sound profiles:", error);
            }
        }
    
        // Function to get CSRF token
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.startsWith(name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    
        // Capture audio from tabs
        async function captureAudioFromTabs() {
            try {
                const stream = await navigator.mediaDevices.getDisplayMedia({ video: true, audio: true });
                const audioTrack = stream.getAudioTracks()[0];
    
                if (!audioTrack) {
                    throw new Error("No audio detected in the selected tab.");
                }
    
                const audioSource = globalAudioContext.createMediaStreamSource(new MediaStream([audioTrack]));
    
                audioSource.connect(gainNode).connect(globalAudioContext.destination);
                eqFilters.forEach(filter => gainNode.connect(filter));
                eqFilters[eqFilters.length - 1].connect(globalAudioContext.destination);
    
                console.log("Capturing audio from active tab...");
                showNotification("Audio capture started", "success");
            } catch (error) {
                console.error("Could not capture tab audio:", error);
                showNotification("Make sure to share a tab with audio when prompted", "error");
            }
        }
    
        // Start listening to ambient sound
        async function startListening() {
            if (isListening) return;
            isListening = true;
    
            // Iniciar el contador de tiempo de exposición
            exposureStartTime = Date.now();
            console.log('time:', exposureStartTime);
            exposureTime = exposureStartTime;
    
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                audioContext = new AudioContext();
                analyser = audioContext.createAnalyser();
                microphone = audioContext.createMediaStreamSource(stream);
                microphone.connect(analyser);
                analyser.fftSize = 256;
                dataArray = new Uint8Array(analyser.frequencyBinCount);
                analyzeAudio();
    
                // Also capture tab audio
                await captureAudioFromTabs();
    
                // Update UI
                document.querySelector('button[onclick="startListening()"]').classList.add('bg-green-600');
                document.querySelector('button[onclick="startListening()"]').classList.remove('bg-blue-600');
            } catch (error) {
                console.error("Error accessing microphone:", error);
                showNotification("Could not access microphone. Check permissions.", "error");
                isListening = false;
            }
        }
    
        // Stop listening
        function stopListening() {
            if (!isListening) return;
            isListening = false;
    
            exposureStartTime = exposureTime;
            exposureTime = 0;
            exposureTimee = Date.now();
    
            console.log('start time:', exposureStartTime);
            console.log('finish time:', exposureTimee);
            console.log('final time:', exposureTimee-exposureStartTime);
    
            // Calcular el tiempo de exposición acumulado
            if (exposureStartTime != null) {
                exposureTime = exposureTimee-exposureStartTime;
                exposureStartTime = null;
            }

            console.log('exposureTime: ', exposureTime)
        
    
            // Actualizar la visualización del tiempo de exposición
            updateExposureTimeDisplay();
    
            // Enviar el tiempo de exposición al servidor
            sendExposureTimeToServer();
    
            if (audioContext) {
                audioContext.close();
            }
            ambientVolumeDisplay.textContent = "Ambient Volume: --";
            document.getElementById('volumeIndicator').style.width = "0%";
    
            // Update UI
            document.querySelector('button[onclick="startListening()"]').classList.remove('bg-green-600');
            document.querySelector('button[onclick="startListening()"]').classList.add('bg-blue-600');
    
            showNotification("Microphone deactivated", "info");
        }
    
        // Analyze audio
        function analyzeAudio() {
            if (!isListening) return;
            analyser.getByteFrequencyData(dataArray);
    
            let volume = dataArray.reduce((sum, val) => sum + val, 0) / dataArray.length;
    
            ambientVolumeDisplay.textContent = `Ambient Volume: ${volume.toFixed(0)}`;
    
            // Update volume indicator
            const volumePercentage = Math.min(100, (volume / 255) * 100);
            document.getElementById('volumeIndicator').style.width = `${volumePercentage}%`;
    
            // Change color based on volume
            if (volumePercentage > 80) {
                document.getElementById('volumeIndicator').className = 'bg-red-600 h-4 rounded-full transition-all duration-300';
            } else if (volumePercentage > 60) {
                document.getElementById('volumeIndicator').className = 'bg-yellow-500 h-4 rounded-full transition-all duration-300';
            } else {
                document.getElementById('volumeIndicator').className = 'bg-blue-600 h-4 rounded-full transition-all duration-300';
            }
    
            adjustVolumeBasedOnAmbient(volume);
            checkNoiseExposure(volume);
    
            requestAnimationFrame(analyzeAudio);
        }
    
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
    
            // Agregar la notificación al cuerpo del documento
            document.body.appendChild(notification);
    
            // Eliminar la notificación después de unos segundos
            setTimeout(() => {
                notification.remove();
            }, 3000);  // La notificación desaparece después de 3 segundos
        }
    
        // Adjust volume based on ambient noise
        async function adjustVolumeBasedOnAmbient(ambientVolume) {
            await ensureAudioContextIsRunning();
    
            const soundProfile = document.getElementById('soundProfile');
            const category = soundProfile ? soundProfile.value : 'music';
    
            let newVolume;
    
            switch (category) {
                case 'Music':
                    newVolume = ambientVolume > 50
                        ? Math.max(0.3, 1.0 - (ambientVolume - 50) / 80)
                        : 1.0;
                    break;
                case 'Podcast':
                    newVolume = ambientVolume > 50
                        ? Math.max(0.4, 0.8 - (ambientVolume - 50) / 120)
                        : 0.8;
                    break;
                case 'Call':
                    newVolume = ambientVolume > 50
                        ? Math.max(0.5, 1.2 - (ambientVolume - 50) / 90)
                        : 1.0;
                    break;
                default:
                    newVolume = 1.0;
            }
    
            newVolume = Math.max(0.1, Math.min(1, newVolume));
    
            gainNode.gain.cancelScheduledValues(globalAudioContext.currentTime);
            gainNode.gain.setTargetAtTime(newVolume, globalAudioContext.currentTime, 0.5);
    
            const volumeDisplay = document.getElementById("tabVolumeDisplay");
            if (volumeDisplay) {
                volumeDisplay.textContent = `${Math.round(newVolume * 100)}%`;
    
                // Change color based on volume
                if (newVolume < 0.3) {
                    volumeDisplay.className = 'font-semibold text-red-500';
                } else if (newVolume < 0.6) {
                    volumeDisplay.className = 'font-semibold text-yellow-500';
                } else {
                    volumeDisplay.className = 'font-semibold text-green-500';
                }
            }
        }
    
        // Ensure audio context is running
        async function ensureAudioContextIsRunning() {
            if (globalAudioContext.state === 'suspended') {
                await globalAudioContext.resume();
                console.log('AudioContext resumed');
            }
        }
    
        // Check for prolonged noise exposure
        function checkNoiseExposure(ambientVolume) {
            const dBThreshold = 85; // 85 dB warning limit
    
            if (ambientVolume >= dBThreshold) {
                if (!exposureStartTime) {
                    exposureStartTime = Date.now(); // Start tracking
                }
    
                let elapsedTime = Date.now() - exposureStartTime;
                if (elapsedTime >= exposureThreshold && !warningTriggered) {
                    console.log('Warning: High noise exposure detected');
                    triggerWarning();
                    warningTriggered = true; // Prevent multiple warnings
                }
            } else {
                exposureStartTime = null; // Reset if volume drops
                warningTriggered = false;
            }
        }
    
        // Trigger warning notification
        function triggerWarning() {
            if (Notification.permission === "granted") {
                new Notification("⚠ High Noise Exposure", {
                    body: "You've been exposed to high noise levels (>85 dB) for too long. Consider lowering the volume or taking a break.",
                    icon: "/static/images/warning-icon.png"
                });
            } else if (Notification.permission !== "denied") {
                Notification.requestPermission().then(permission => {
                    if (permission === "granted") {
                        triggerWarning();
                    }
                });
            } else {
                showNotification("High Noise Exposure Warning: You've been listening to loud sounds for too long!", "warning");
            }
            
            sendRiskNotification();
        }

        async function sendRiskNotification() { //just trying to save to db
            const csrfToken = getCookie("csrftoken");
        
            try {
                const response = await fetch("/record_hearing_risk/", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "X-CSRFToken": csrfToken,
                    },
                    body: JSON.stringify({
                        warning_type: "High Noise Exposure",
                        exposure_threshold: 10, // Example threshold
                    }),
                });
        
                const data = await response.json();
                if (data.status === "success") {
                    console.log("Hearing risk notification recorded successfully:", data);
                } else {
                    console.error("Failed to record hearing risk:", data.message);
                }
            } catch (error) {
                console.error("Error sending risk notification:", error);
            }
        }
    
        // Setup equalizer
        async function setupEqualizer() {
            eqFilters = frequencies.map((freq, index) => {
                const filter = globalAudioContext.createBiquadFilter();
                filter.type = "peaking";
                filter.frequency.value = freq;
                filter.Q.value = 1.414;
                filter.gain.value = 0;
                return filter;
            });
    
            // Chain filters
            for (let i = 0; i < eqFilters.length - 1; i++) {
                eqFilters[i].connect(eqFilters[i + 1]);
            }
    
            // Connect gain node to first filter
            gainNode.connect(eqFilters[0]);
    
            // Connect last filter to destination
            eqFilters[eqFilters.length - 1].connect(globalAudioContext.destination);
        }
    
        // Update equalizer when slider changes
        function updateEqualizer(frequency, value) {
            const index = frequencies.indexOf(frequency);
            if (index !== -1) {
                eqFilters[index].gain.setTargetAtTime(parseFloat(value), globalAudioContext.currentTime, 0.1);
    
                // Actualizar visualización
                document.getElementById(`eq-value-${frequency}`).textContent = `${value} dB`;
    
                // Mapear de -30 a 30 dB en porcentaje de 0% a 100%
                const heightPercentage = ((parseFloat(value) + 30) / 60) * 100;
                document.getElementById(`eq-level-${frequency}`).style.height = `${heightPercentage}%`;
            }
        }
    
        // Update master volume
        function updateMasterVolume(value) {
            const volumeValue = parseFloat(value) / 100;
            gainNode.gain.setTargetAtTime(volumeValue, globalAudioContext.currentTime, 0.1);
            document.getElementById('masterVolumeValue').textContent = `${value}%`;
        }
    
        // Apply equalizer presets
        function applyPreset(preset) {
            let values = [];
    
            switch (preset) {
                case 'flat':
                    values = [0, 0, 0, 0, 0];
                    break;
                case 'bass':
                    values = [15, 8, 0, -2, -5];
                    break;
                case 'vocal':
                    values = [-5, 0, 10, 5, -5];
                    break;
                case 'treble':
                    values = [-10, -5, 0, 10, 15];
                    break;
            }
    
            // Apply values to sliders and update equalizer
            frequencies.forEach((freq, index) => {
                const slider = document.getElementById(`eq${freq}`);
                slider.value = values[index];
                updateEqualizer(freq, values[index]);
            });
    
            showNotification(`Applied ${preset} preset`, "success");
        }
    
        // Apply sound profile
        async function applySoundProfile(profileName = null) {
    
            try {
                if (!profileName) {
                    profileName = document.getElementById("soundProfile").value;
                }
    
                const response = await fetch(`/apply_profile_by_name/${profileName}/`);
                const data = await response.json();
    
                if (data.status === "success") {
                    console.log(`Applying profile: ${profileName}`, data.profile);
    
                    // Aplicar ajustes del perfil al ecualizador
                    if (data.profile.bass !== undefined) {
                        updateEqualizer(60, data.profile.bass / 2 - 25);
                        document.getElementById('eq60').value = data.profile.bass / 2 - 25;
                    }
                    if (data.profile.mid !== undefined) {
                        updateEqualizer(1000, data.profile.mid / 2 - 25);
                        document.getElementById('eq1000').value = data.profile.mid / 2 - 25;
                    }
                    if (data.profile.treble !== undefined) {
                        updateEqualizer(16000, data.profile.treble / 2 - 25);
                        document.getElementById('eq16000').value = data.profile.treble / 2 - 25;
                    }
                }
    
            } catch (error) {
                console.error("Error applying profile:", error)
            }
        }
    
        // Update exposure time display
        function updateExposureTimeDisplay() {
            const exposureTimeDisplay = document.getElementById("exposureTimeDisplay");
            if (exposureTimeDisplay) {
                const seconds = Math.floor(exposureTime / 1000);  // Convertir milisegundos a segundos
                exposureTimeDisplay.textContent = `Exposure Time: ${seconds} seconds`;
            } else {
                console.error('Element with ID "exposureTimeDisplay" not found');
            }
        }
    
        async function sendExposureTimeToServer() {
            const csrfToken = getCookie('csrftoken');
            console.log('exposureTime to send: ', exposureTime);
            const exposureTimeInMinutes = Math.floor(exposureTime / 60000);
            console.log('exposureTime minutos conversion: ', exposureTimeInMinutes);
    
            try {
                const response = await fetch('/save_exposure_time/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken,
                    },
                    body: JSON.stringify({
                        exposure_time: exposureTimeInMinutes,  // Asegúrate de que este valor sea correcto
                    }),
                });
    
                if (response.ok) {
                    console.log('Exposure time saved successfully');
                    console.log('Exposure time to send:', exposureTimeInMinutes);
                } else {
                    console.error('Failed to save exposure time');
                }
            } catch (error) {
                console.error('Error saving exposure time:', error);
            }
        }
    
        // Cargar perfiles al iniciar
        document.addEventListener("DOMContentLoaded", loadSoundProfiles);
    
        // Dark mode toggle
        document.getElementById('darkModeToggle').addEventListener('click', () => {
            const isDark = document.documentElement.classList.toggle('dark');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
        });
    
        // Check for saved theme preference
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme === 'dark') {
            document.documentElement.classList.add('dark');
        }
    
        // Initialize equalizer display
        frequencies.forEach(freq => {
            updateEqualizer(freq, 0);
        });
    </script>
</body>

</html>