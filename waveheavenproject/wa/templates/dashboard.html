{% load static %}
<!DOCTYPE html>
<html lang="en" class="light">
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/lucide@latest"></script>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WaveHeaven Dashboard</title>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: {
                            DEFAULT: '#3b82f6',
                            dark: '#60a5fa',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        /* Custom styles for equalizer */
        .eq-container {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            height: 250px;
            padding: 20px;
            background: rgba(59, 130, 246, 0.05);
            border-radius: 12px;
            position: relative;
        }

        .eq-band {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 18%;
            height: 100%;
            position: relative;
        }

        .eq-slider-container {
            height: 180px;
            width: 100%;
            background: rgba(59, 130, 246, 0.1);
            border-radius: 12px;
            position: relative;
            overflow: hidden;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .eq-slider {
            -webkit-appearance: none;
            appearance: none;
            width: 180px;
            height: 40px;
            background: transparent;
            outline: none;
            transform: rotate(-90deg) translateY(-70px);
            transform-origin: center;
            position: absolute;
            top: 50%;
            left: 50%;
            margin-left: -90px;
            margin-top: -20px;
        }

        .eq-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #3b82f6;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
            border: 2px solid white;
            transition: all 0.2s ease;
        }

        .eq-slider::-webkit-slider-thumb:hover {
            background: #2563eb;
            transform: scale(1.1);
        }

        .eq-slider::-webkit-slider-runnable-track {
            width: 100%;
            height: 8px;
            cursor: pointer;
            background: #e2e8f0;
            border-radius: 4px;
        }

        .dark .eq-slider::-webkit-slider-runnable-track {
            background: #374151;
        }

        .dark .eq-slider::-webkit-slider-thumb {
            background: #60a5fa;
            border: 2px solid #1f2937;
        }

        .eq-level {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to top, #3b82f6, #60a5fa);
            border-radius: 8px;
            transition: height 0.3s ease;
        }

        .dark .eq-level {
            background: linear-gradient(to top, #60a5fa, #93c5fd);
        }

        .eq-value {
            font-size: 0.875rem;
            font-weight: 600;
            color: #3b82f6;
            margin-top: 8px;
            min-height: 1.5rem;
        }

        .dark .eq-value {
            color: #60a5fa;
        }

        .eq-freq {
            font-size: 0.875rem;
            font-weight: 500;
            margin-top: 8px;
        }

        .eq-grid-lines {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
        }

        .eq-grid-line {
            position: absolute;
            left: 0;
            right: 0;
            height: 1px;
            background: rgba(203, 213, 225, 0.5);
        }

        .dark .eq-grid-line {
            background: rgba(75, 85, 99, 0.5);
        }

        .eq-grid-label {
            position: absolute;
            left: -30px;
            font-size: 0.7rem;
            color: #94a3b8;
        }

        .dark .eq-grid-label {
            color: #64748b;
        }

        /* Preset buttons */
        .preset-btn {
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
        }

        .preset-btn::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 5px;
            height: 5px;
            background: rgba(255, 255, 255, 0.5);
            opacity: 0;
            border-radius: 100%;
            transform: scale(1, 1) translate(-50%, -50%);
            transform-origin: 50% 50%;
        }

        .preset-btn:hover::after {
            animation: ripple 1s ease-out;
        }

        @keyframes ripple {
            0% {
                transform: scale(0, 0);
                opacity: 0.5;
            }

            100% {
                transform: scale(20, 20);
                opacity: 0;
            }
        }

        /* Party Mode Styles */
        #party-controls input {
            background-color: #fff;
            color: #000;
            border: 1px solid #d1d5db;
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            width: 120px;
        }

        .dark #party-controls input {
            background-color: #374151;
            border-color: #4b5563;
            color: #fff;
        }

        #party-controls button {
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.25rem;
            font-size: 0.875rem;
        }
    </style>
</head>

<body
    class="flex flex-col min-h-screen bg-white dark:bg-gray-900 text-gray-900 dark:text-gray-100 transition-colors duration-200">

    <!-- Header -->
    <header class="px-4 lg:px-6 h-14 flex items-center border-b">
        <a href="/" class="flex items-center justify-center">
            <i data-lucide="audio-waveform" class="h-6 w-6 text-blue-600 dark:text-blue-400"></i>
            <span
                class="ml-2 text-lg font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-500 to-purple-500">
                WaveHeaven
            </span>
        </a>
        <nav class="ml-auto flex gap-4 sm:gap-6">
            <a href="{% url 'profiles_page' %}" class="text-sm font-medium hover:underline underline-offset-4">Sound
                Profiles</a>
            <a href="{% url 'user_statistics' %}"
                class="text-sm font-medium hover:underline underline-offset-4">Statistics</a>
            <a href="{% url 'hearing_test' %}" class="text-sm font-medium hover:underline underline-offset-4">Hearing
                Test</a>
            <button id="darkModeToggle" class="text-sm font-medium hover:underline underline-offset-4">
                <i data-lucide="sun" class="h-5 w-5 dark:hidden"></i>
                <i data-lucide="moon" class="h-5 w-5 hidden dark:inline"></i>
                <span class="sr-only">Toggle mode</span>
            </button>
            <a href="{% url 'logout' %}"
                class="text-sm font-medium text-red-500 hover:underline underline-offset-4">Logout</a>
        </nav>
    </header>

    <!-- Main Content -->
    <main class="flex-1 p-6">
        <div class="max-w-4xl mx-auto">
            <h1 class="text-3xl font-bold text-center mb-8">Welcome to WaveHeaven</h1>
            <p class="text-center text-gray-500 dark:text-gray-400 mb-12">
                Your personalized sound experience starts here.
            </p>

            <!-- Feature Boxes -->
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-6 mb-12">
                <a href="{% url 'profiles_page' %}"
                    class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md text-center hover:bg-gray-100 dark:hover:bg-gray-700 transition">
                    <i data-lucide="music" class="h-10 w-10 mx-auto text-blue-600 dark:text-blue-400"></i>
                    <h3 class="text-lg font-semibold mt-4">Sound Profiles</h3>
                    <p class="text-gray-500 dark:text-gray-400">Manage your personalized sound profiles.</p>
                </a>
                <a href="{% url 'user_statistics' %}"
                    class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md text-center hover:bg-gray-100 dark:hover:bg-gray-700 transition">
                    <i data-lucide="bar-chart" class="h-10 w-10 mx-auto text-green-600 dark:text-green-400"></i>
                    <h3 class="text-lg font-semibold mt-4">Statistics</h3>
                    <p class="text-gray-500 dark:text-gray-400">View your personalized listening insights.</p>
                </a>
                <a href="{% url 'hearing_test' %}"
                    class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md text-center hover:bg-gray-100 dark:hover:bg-gray-700 transition">
                    <i data-lucide="ear" class="h-10 w-10 mx-auto text-orange-600 dark:text-orange-400"></i>
                    <h3 class="text-lg font-semibold mt-4">Hearing Test</h3>
                    <p class="text-gray-500 dark:text-gray-400">Take a hearing test and adjust your settings.</p>
                </a>
            </div>

            <!-- Party Mode Section -->
            <section class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow-md mb-6 mx-auto max-w-4xl">
                <div class="flex items-center justify-between">
                    <h2 class="text-xl font-semibold flex items-center gap-2">
                        <i data-lucide="users" class="h-5 w-5 text-purple-600"></i>
                        Party Mode
                    </h2>

                    <div id="party-controls">
                        {% if user_prefs.in_party_mode %}
                        <div class="flex items-center gap-4">
                            <span class="text-sm">Session: {{ user_prefs.current_party.session_code }}</span>
                            <button onclick="leaveParty() "
                                class="px-3 py-1 bg-red-600 text-white rounded-md hover:bg-red-700 transition flex items-center gap-1">
                                <i data-lucide="log-out" class="h-4 w-4"></i>
                                Leave
                            </button>
                            {% if user_prefs.current_party.participants.all %}
                            <div class="mt-2">
                                <p class="font-semibold">Participants:</p>
                                <ul>
                                    {% for participant in user_prefs.current_party.participants.all %}
                                    <li>{{ participant.user.username }}
                                        {% if participant == user_prefs.current_party.host %}
                                        (Host)
                                        {% endif %}
                                    </li>
                                    {% endfor %}
                                </ul>
                            </div>
                            {% endif %}
                        </div>
                        {% else %}
                        <div class="flex gap-2">
                            <input type="text" id="party-code" placeholder="Enter code"
                                class="px-3 py-1 border rounded-md dark:bg-gray-700 dark:border-gray-600">
                            <button onclick="joinParty()"
                                class="px-3 py-1 bg-green-600 text-white rounded-md hover:bg-green-700 transition flex items-center gap-1">
                                <i data-lucide="plus" class="h-4 w-4"></i>
                                Join
                            </button>
                            <button onclick="createParty()"
                                class="px-3 py-1 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition flex items-center gap-1">
                                <i data-lucide="party-popper" class="h-4 w-4"></i>
                                Create
                            </button>
                        </div>
                        {% endif %}
                    </div>
                </div>
                <div id="chat-container" class="mt-4 p-4 bg-gray-100 dark:bg-gray-700 rounded-md h-48 overflow-y-auto">
                </div>
                <div class="flex mt-2">
                    <input type="text" id="chat-message-input" class="flex-1 px-3 py-1 rounded-md dark:bg-gray-800"
                        placeholder="Type your message...">
                    <button onclick="sendMessage()"
                        class="ml-2 px-3 py-1 bg-blue-600 text-white rounded-md hover:bg-blue-700">Send</button>
                </div>
            </section>

            <!-- Audio Capture & Automatic Adjustment -->
            <section id="audio-control" class="mt-12">
                <h2 class="text-2xl font-semibold text-center mb-4">Try WaveHeaven</h2>
                <p class="text-center text-gray-500 dark:text-gray-400 mb-6">
                    Experience real-time automatic volume adjustment.
                </p>

                <div class="flex flex-col items-center space-y-4">
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md w-full">
                        <p id="ambientVolumeDisplay" class="text-xl font-semibold text-center mb-4">Ambient Volume: --
                        </p>
                        <div class="flex justify-center space-x-4 mb-6">
                            <button onclick="startListening()"
                                class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition flex items-center">
                                <i data-lucide="mic" class="mr-2 h-4 w-4"></i>
                                Activate Microphone
                            </button>
                            <button onclick="stopListening()"
                                class="px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 rounded-md hover:bg-gray-300 dark:hover:bg-gray-600 transition flex items-center">
                                <i data-lucide="mic-off" class="mr-2 h-4 w-4"></i>
                                Deactivate Microphone
                            </button>
                        </div>
                        <div class="flex items-center justify-center mb-4">
                            <div class="w-full max-w-md bg-gray-200 dark:bg-gray-700 rounded-full h-4 overflow-hidden">
                                <div id="volumeIndicator"
                                    class="bg-blue-600 h-4 rounded-full transition-all duration-300" style="width: 50%">
                                </div>
                            </div>
                        </div>
                        <p class="text-lg text-center">Tab Volume: <span id="tabVolumeDisplay"
                                class="font-semibold">100%</span></p>
                        <p id="exposureTimeDisplay" class="text-lg text-center">Exposure Time: <span
                                class="font-semibold">0 minutes</span></p>
                    </div>

                    <!-- Enhanced Equalizer Section -->
                    <section id="equalizer" class="w-full bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-semibold"> Equalizer</h2>
                            <div class="flex space-x-2">
                                <!-- Flat -->
                                <div class="relative group">
                                    <button onclick="applyPreset('flat')"
                                        class="preset-btn px-3 py-1 text-sm bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 rounded-md hover:bg-gray-300 dark:hover:bg-gray-600 transition">
                                        Flat
                                    </button>
                                    <span
                                        class="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 w-max px-2 py-1 text-xs text-white bg-black bg-opacity-75 rounded opacity-0 group-hover:opacity-100 transition-opacity">
                                        Resets all bands to 0 dB
                                    </span>
                                </div>

                                <!-- Bass Boost -->
                                <div class="relative group">
                                    <button onclick="applyPreset('bass')"
                                        class="preset-btn px-3 py-1 text-sm bg-blue-100 dark:bg-blue-900/50 text-blue-800 dark:text-blue-200 rounded-md hover:bg-blue-200 dark:hover:bg-blue-800 transition">
                                        Bass Boost
                                    </button>
                                    <span
                                        class="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 w-max px-2 py-1 text-xs text-white bg-black bg-opacity-75 rounded opacity-0 group-hover:opacity-100 transition-opacity">
                                        Enhances low frequencies for deeper bass
                                    </span>
                                </div>

                                <!-- Vocal Clarity -->
                                <div class="relative group">
                                    <button onclick="applyPreset('vocal')"
                                        class="preset-btn px-3 py-1 text-sm bg-purple-100 dark:bg-purple-900/50 text-purple-800 dark:text-purple-200 rounded-md hover:bg-purple-200 dark:hover:bg-purple-800 transition">
                                        Vocal Clarity
                                    </button>
                                    <span
                                        class="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 w-max px-2 py-1 text-xs text-white bg-black bg-opacity-75 rounded opacity-0 group-hover:opacity-100 transition-opacity">
                                        Boosts mid frequencies for clear vocals
                                    </span>
                                </div>

                                <!-- Treble Boost -->
                                <div class="relative group">
                                    <button onclick="applyPreset('treble')"
                                        class="preset-btn px-3 py-1 text-sm bg-green-100 dark:bg-green-900/50 text-green-800 dark:text-green-200 rounded-md hover:bg-green-200 dark:hover:bg-green-800 transition">
                                        Treble Boost
                                    </button>
                                    <span
                                        class="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 w-max px-2 py-1 text-xs text-white bg-black bg-opacity-75 rounded opacity-0 group-hover:opacity-100 transition-opacity">
                                        Accentuates high frequencies for sharper detail
                                    </span>
                                </div>
                            </div>
                        </div>

                        <div class="eq-container">
                            <!-- Grid lines for reference -->
                            <div class="eq-grid-lines">
                                <div class="eq-grid-line" style="top: 25%;">
                                    <span class="eq-grid-label">+15dB</span>
                                </div>
                                <div class="eq-grid-line" style="top: 50%;">
                                    <span class="eq-grid-label">0dB</span>
                                </div>
                                <div class="eq-grid-line" style="top: 75%;">
                                    <span class="eq-grid-label">-15dB</span>
                                </div>
                            </div>

                            <!-- 60Hz Band -->
                            <div class="eq-band" data-freq="60">
                                <div class="eq-slider-container">
                                    <div class="eq-level" id="eq-level-60" style="height: 50%;"></div>
                                    <input type="range" id="eq60" class="eq-slider" min="-30" max="30" value="0"
                                        step="1" oninput="updateEqualizer(60, this.value)">
                                </div>
                                <div class="eq-value" id="eq-value-60">0 dB</div>
                                <div class="eq-freq">60Hz</div>
                            </div>

                            <!-- 250Hz Band -->
                            <div class="eq-band" data-freq="250">
                                <div class="eq-slider-container">
                                    <div class="eq-level" id="eq-level-250" style="height: 50%;"></div>
                                    <input type="range" id="eq250" class="eq-slider" min="-30" max="30" value="0"
                                        step="1" oninput="updateEqualizer(250, this.value)">
                                </div>
                                <div class="eq-value" id="eq-value-250">0 dB</div>
                                <div class="eq-freq">250Hz</div>
                            </div>

                            <!-- 1kHz Band -->
                            <div class="eq-band" data-freq="1000">
                                <div class="eq-slider-container">
                                    <div class="eq-level" id="eq-level-1000" style="height: 50%;"></div>
                                    <input type="range" id="eq1000" class="eq-slider" min="-30" max="30" value="0"
                                        step="1" oninput="updateEqualizer(1000, this.value)">
                                </div>
                                <div class="eq-value" id="eq-value-1000">0 dB</div>
                                <div class="eq-freq">1kHz</div>
                            </div>

                            <!-- 4kHz Band -->
                            <div class="eq-band" data-freq="4000">
                                <div class="eq-slider-container">
                                    <div class="eq-level" id="eq-level-4000" style="height: 50%;"></div>
                                    <input type="range" id="eq4000" class="eq-slider" min="-30" max="30" value="0"
                                        step="1" oninput="updateEqualizer(4000, this.value)">
                                </div>
                                <div class="eq-value" id="eq-value-4000">0 dB</div>
                                <div class="eq-freq">4kHz</div>
                            </div>

                            <!-- 16kHz Band -->
                            <div class="eq-band" data-freq="16000">
                                <div class="eq-slider-container">
                                    <div class="eq-level" id="eq-level-16000" style="height: 50%;"></div>
                                    <input type="range" id="eq16000" class="eq-slider" min="-30" max="30" value="0"
                                        step="1" oninput="updateEqualizer(16000, this.value)">
                                </div>
                                <div class="eq-value" id="eq-value-16000">0 dB</div>
                                <div class="eq-freq">16kHz</div>
                            </div>
                        </div>

                        <div class="mt-6">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-sm font-medium">Master Volume</span>
                                <span class="text-sm font-medium" id="masterVolumeValue">100%</span>
                            </div>
                            <input type="range" id="masterVolume" min="0" max="100" value="100" step="1"
                                class="w-full h-2 bg-gray-200 dark:bg-gray-700 rounded-full appearance-none cursor-pointer"
                                oninput="updateMasterVolume(this.value)">
                        </div>
                    </section>

                    <!-- Sound Profile Selection -->
                    <div class="w-full bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md mt-6">
                        <h3 class="text-lg font-semibold mb-4">Sound Profile</h3>
                        <div class="flex flex-col sm:flex-row sm:items-center gap-4">
                            <div class="flex-1">
                                <label for="soundProfile" class="block text-sm font-medium mb-2">Select a Sound
                                    Profile:</label>
                                <select id="soundProfile"
                                    class="w-full px-4 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md">
                                    {% for profile in user_prefs.audio_profiles %}
                                    <option value="{{ profile.name }}">{{ profile.name }}</option>
                                    {% empty %}
                                    <option disabled>No sound profiles available</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <button onclick="applySoundProfile()"
                                class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition flex items-center justify-center">
                                <i data-lucide="check" class="h-4 w-4 mr-2"></i>
                                Apply Profile
                            </button>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <footer class="flex flex-col gap-2 sm:flex-row py-6 w-full shrink-0 items-center px-4 md:px-6 border-t">
        <p class="text-xs text-gray-500 dark:text-gray-400">© 2025 WaveHeaven. All rights reserved.</p>
        <nav class="sm:ml-auto flex gap-4 sm:gap-6">
            <a class="text-xs hover:underline underline-offset-4" href="#">Terms of Service</a>
            <a class="text-xs hover:underline underline-offset-4" href="#">Privacy Policy</a>
        </nav>
    </footer>

    <script>
        // Initialize Lucide icons
        lucide.createIcons();

        // Variables for audio processing
        let audioContext;
        let analyser;
        let microphone;
        let dataArray;
        let isListening = false;
        let ambientVolumeDisplay = document.getElementById("ambientVolumeDisplay");
        let activeTabId = null;
        let globalAudioContext = new (window.AudioContext || window.webkitAudioContext)();
        let gainNode = globalAudioContext.createGain(); // Volume controller
        let sourceNode = globalAudioContext.createGain(); // Volume controller
        let exposureStartTime = null;
        let exposureTime = 0; // Tiempo de exposición acumulado en milisegundos
        let exposureThreshold = 5 * 1000; // 5 seconds in milliseconds (just to test later it should be 10 minutes)
        let warningTriggered = false;
        let eqFilters = [];

        const frequencies = [60, 250, 1000, 4000, 16000];

        const selectSoundProfile = document.querySelector("#soundProfile");

        selectSoundProfile.addEventListener("change", function (e) {
            e.preventDefault();
            e.stopImmediatePropagation();
            // updateEqualizer();
        });

        // Initialize equalizer
        setupEqualizer();
        filledSoundProfile();

        // Función para cargar perfiles
        async function filledSoundProfile() {
            try {
                const response = await fetch('/list_profiles/');
                const data = await response.json();
                const selectElement = document.getElementById("soundProfile");

                // Limpiar opciones previas
                selectElement.innerHTML = "";

                if (data.profiles.length === 0) {
                    selectElement.innerHTML = `<option disabled>No sound profiles available</option>`;
                    return;
                }

                data.profiles.forEach(applied_profile => {
                    let option = document.createElement("option");
                    option.value = applied_profile.name;
                    option.textContent = applied_profile.name;
                    selectElement.appendChild(option);
                });

                // Aplicar automáticamente el último perfil si está guardado
                const lastProfile = localStorage.getItem('lastAppliedProfile');
                const profileNames = data.profiles.map(p => p.name);

                if (lastProfile && profileNames.includes(lastProfile)) {
                    applySoundProfile(lastProfile);
                    document.getElementById("soundProfile").value = lastProfile;
                } else if (data.profiles.length > 0) {
                    applySoundProfile(data.profiles[0].name);
                    document.getElementById("soundProfile").value = data.profiles[0].name;
                }


            } catch (error) {
                console.error("Error loading sound profiles:", error);
            }
        }


        // Function to get CSRF token
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.startsWith(name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // Capture audio from tabs
        async function captureAudioFromTabs() {
            try {
                const stream = await navigator.mediaDevices.getDisplayMedia({ video: true, audio: true });
                const audioTrack = stream.getAudioTracks()[0];

                if (!audioTrack) {
                    throw new Error("No audio detected in the selected tab.");
                }

                const audioSource = globalAudioContext.createMediaStreamSource(new MediaStream([audioTrack]));

                audioSource.connect(gainNode).connect(globalAudioContext.destination);
                eqFilters.forEach(filter => gainNode.connect(filter));
                eqFilters[eqFilters.length - 1].connect(globalAudioContext.destination);

                console.log("Capturing audio from active tab...");
                showNotification("Audio capture started", "success");
            } catch (error) {
                console.error("Could not capture tab audio:", error);
                showNotification("Make sure to share a tab with audio when prompted", "error");
            }
        }

        // Start listening to ambient sound
        async function startListening() {
            if (isListening) return;
            isListening = true;

            // Iniciar el contador de tiempo de exposición
            exposureStartTime = Date.now();
            console.log('time:', exposureStartTime);
            exposureTime = exposureStartTime;

            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                audioContext = new AudioContext();
                analyser = audioContext.createAnalyser();
                microphone = audioContext.createMediaStreamSource(stream);
                microphone.connect(analyser);
                analyser.fftSize = 256;
                dataArray = new Uint8Array(analyser.frequencyBinCount);
                analyzeAudio();

                // Also capture tab audio
                await captureAudioFromTabs();

                // Update UI
                document.querySelector('button[onclick="startListening()"]').classList.add('bg-green-600');
                document.querySelector('button[onclick="startListening()"]').classList.remove('bg-blue-600');
            } catch (error) {
                console.error("Error accessing microphone:", error);
                showNotification("Could not access microphone. Check permissions.", "error");
                isListening = false;
            }
        }

        // Stop listening
        function stopListening() {
            if (!isListening) return;
            isListening = false;

            exposureStartTime = exposureTime;
            exposureTime = 0;
            exposureTimee = Date.now();

            console.log('start time:', exposureStartTime);
            console.log('finish time:', exposureTimee);
            console.log('final time:', exposureTimee - exposureStartTime);

            // Calcular el tiempo de exposición acumulado
            if (exposureStartTime != null) {
                exposureTime = exposureTimee - exposureStartTime;
                exposureStartTime = null;
            }

            console.log('exposureTime: ', exposureTime)


            // Actualizar la visualización del tiempo de exposición
            updateExposureTimeDisplay();

            // Enviar el tiempo de exposición al servidor
            sendExposureTimeToServer();

            if (audioContext) {
                audioContext.close();
            }
            ambientVolumeDisplay.textContent = "Ambient Volume: --";
            document.getElementById('volumeIndicator').style.width = "0%";

            // Update UI
            document.querySelector('button[onclick="startListening()"]').classList.remove('bg-green-600');
            document.querySelector('button[onclick="startListening()"]').classList.add('bg-blue-600');

            showNotification("Microphone deactivated", "info");
        }

        // Analyze audio
        function analyzeAudio() {
            if (!isListening) return;
            analyser.getByteFrequencyData(dataArray);

            let volume = dataArray.reduce((sum, val) => sum + val, 0) / dataArray.length;

            ambientVolumeDisplay.textContent = `Ambient Volume: ${volume.toFixed(0)}`;

            // Update volume indicator
            const volumePercentage = Math.min(100, (volume / 255) * 100);
            document.getElementById('volumeIndicator').style.width = `${volumePercentage}%`;

            // Change color based on volume
            if (volumePercentage > 80) {
                document.getElementById('volumeIndicator').className = 'bg-red-600 h-4 rounded-full transition-all duration-300';
            } else if (volumePercentage > 60) {
                document.getElementById('volumeIndicator').className = 'bg-yellow-500 h-4 rounded-full transition-all duration-300';
            } else {
                document.getElementById('volumeIndicator').className = 'bg-blue-600 h-4 rounded-full transition-all duration-300';
            }

            adjustVolumeBasedOnAmbient(volume);
            checkNoiseExposure(volume);

            requestAnimationFrame(analyzeAudio);
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;

            // Agregar la notificación al cuerpo del documento
            document.body.appendChild(notification);

            // Eliminar la notificación después de unos segundos
            setTimeout(() => {
                notification.remove();
            }, 3000);  // La notificación desaparece después de 3 segundos
        }

        // Adjust volume based on ambient noise
        async function adjustVolumeBasedOnAmbient(ambientVolume) {
            await ensureAudioContextIsRunning();

            const soundProfile = document.getElementById('soundProfile');
            const category = soundProfile ? soundProfile.value : 'music';

            let newVolume;

            switch (category) {
                case 'Music':
                    newVolume = ambientVolume > 50
                        ? Math.max(0.3, 1.0 - (ambientVolume - 50) / 80)
                        : 1.0;
                    break;
                case 'Podcast':
                    newVolume = ambientVolume > 50
                        ? Math.max(0.4, 0.8 - (ambientVolume - 50) / 120)
                        : 0.8;
                    break;
                case 'Call':
                    newVolume = ambientVolume > 50
                        ? Math.max(0.5, 1.2 - (ambientVolume - 50) / 90)
                        : 1.0;
                    break;
                default:
                    newVolume = 1.0;
            }

            newVolume = Math.max(0.1, Math.min(1, newVolume));

            gainNode.gain.cancelScheduledValues(globalAudioContext.currentTime);
            gainNode.gain.setTargetAtTime(newVolume, globalAudioContext.currentTime, 0.5);

            const volumeDisplay = document.getElementById("tabVolumeDisplay");
            if (volumeDisplay) {
                volumeDisplay.textContent = `${Math.round(newVolume * 100)}%`;

                // Change color based on volume
                if (newVolume < 0.3) {
                    volumeDisplay.className = 'font-semibold text-red-500';
                } else if (newVolume < 0.6) {
                    volumeDisplay.className = 'font-semibold text-yellow-500';
                } else {
                    volumeDisplay.className = 'font-semibold text-green-500';
                }
            }
        }

        // Ensure audio context is running
        async function ensureAudioContextIsRunning() {
            if (globalAudioContext.state === 'suspended') {
                await globalAudioContext.resume();
                console.log('AudioContext resumed');
            }
        }

        // Check for prolonged noise exposure
        function checkNoiseExposure(ambientVolume) {
            const dBThreshold = 85; // 85 dB warning limit

            if (ambientVolume >= dBThreshold) {
                if (!exposureStartTime) {
                    exposureStartTime = Date.now(); // Start tracking
                }

                let elapsedTime = Date.now() - exposureStartTime;
                if (elapsedTime >= exposureThreshold && !warningTriggered) {
                    console.log('Warning: High noise exposure detected');
                    triggerWarning();
                    warningTriggered = true; // Prevent multiple warnings
                }
            } else {
                exposureStartTime = null; // Reset if volume drops
                warningTriggered = false;
            }
        }

        // Trigger warning notification
        function triggerWarning() {
            if (Notification.permission === "granted") {
                new Notification("⚠ High Noise Exposure", {
                    body: "You've been exposed to high noise levels (>85 dB) for too long. Consider lowering the volume or taking a break.",
                    icon: "/static/images/warning-icon.png"
                });
            } else if (Notification.permission !== "denied") {
                Notification.requestPermission().then(permission => {
                    if (permission === "granted") {
                        triggerWarning();
                    }
                });
            } else {
                showNotification("High Noise Exposure Warning: You've been listening to loud sounds for too long!", "warning");
            }

            sendRiskNotification();
        }

        async function sendRiskNotification() { //just trying to save to db
            const csrfToken = getCookie("csrftoken");

            try {
                const response = await fetch("/record_hearing_risk/", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "X-CSRFToken": csrfToken,
                    },
                    body: JSON.stringify({
                        warning_type: "High Noise Exposure",
                        exposure_threshold: 10, // Example threshold
                    }),
                });

                const data = await response.json();
                if (data.status === "success") {
                    console.log("Hearing risk notification recorded successfully:", data);
                } else {
                    console.error("Failed to record hearing risk:", data.message);
                }
            } catch (error) {
                console.error("Error sending risk notification:", error);
            }
        }

        // Setup equalizer
        async function setupEqualizer() {
            eqFilters = frequencies.map((freq, index) => {
                const filter = globalAudioContext.createBiquadFilter();
                filter.type = "peaking";
                filter.frequency.value = freq;
                filter.Q.value = 1.414;
                filter.gain.value = 0;
                return filter;
            });

            // Chain filters
            for (let i = 0; i < eqFilters.length - 1; i++) {
                eqFilters[i].connect(eqFilters[i + 1]);
            }

            // Connect gain node to first filter
            gainNode.connect(eqFilters[0]);

            // Connect last filter to destination
            eqFilters[eqFilters.length - 1].connect(globalAudioContext.destination);
        }

        // Update equalizer when slider changes
        function updateEqualizer(frequency, value) {
            const index = frequencies.indexOf(frequency);
            if (index !== -1) {
                eqFilters[index].gain.setTargetAtTime(parseFloat(value), globalAudioContext.currentTime, 0.1);

                // Actualizar visualización
                document.getElementById(`eq-value-${frequency}`).textContent = `${value} dB`;

                // Mapear de -30 a 30 dB en porcentaje de 0% a 100%
                const heightPercentage = ((parseFloat(value) + 30) / 60) * 100;
                document.getElementById(`eq-level-${frequency}`).style.height = `${heightPercentage}%`;
            }
        }

        // Update master volume
        function updateMasterVolume(value) {
            const volumeValue = parseFloat(value) / 100;
            gainNode.gain.setTargetAtTime(volumeValue, globalAudioContext.currentTime, 0.1);
            document.getElementById('masterVolumeValue').textContent = `${value}%`;
        }

        // Apply equalizer presets
        function applyPreset(preset) {
            let values = [];

            switch (preset) {
                case 'flat':
                    values = [0, 0, 0, 0, 0];
                    break;
                case 'bass':
                    values = [15, 8, 0, -2, -5];
                    break;
                case 'vocal':
                    values = [-5, 0, 10, 5, -5];
                    break;
                case 'treble':
                    values = [-10, -5, 0, 10, 15];
                    break;
            }

            // Apply values to sliders and update equalizer
            frequencies.forEach((freq, index) => {
                const slider = document.getElementById(`eq${freq}`);
                slider.value = values[index];
                updateEqualizer(freq, values[index]);
            });

            showNotification(`Applied ${preset} preset`, "success");
        }

        // Apply sound profile
        async function applySoundProfile(profileName = null) {
            try {
                if (!profileName) {
                    profileName = document.getElementById("soundProfile").value;
                }

                if (typeof userInPartyMode !== "undefined" && userInPartyMode) {
                    const response = await fetch('/party/get_settings/');
                    const settings = await response.json();

                    // Aplicar valores del grupo
                    updateEqualizer(60, settings.bass);
                    updateEqualizer(1000, settings.mid);
                    updateEqualizer(16000, settings.treble);
                } else {
                    const response = await fetch(`/apply_profile_by_name/${profileName}/`);
                    const data = await response.json();

                    if (data.status === "success") {
                        console.log(`Applying profile: ${profileName}`, data.profile);

                        // Aplicar ajustes del perfil al ecualizador
                        if (data.applied_profile.bass !== undefined) {
                            updateEqualizer(60, data.applied_profile.bass / 2 - 25);
                            document.getElementById('eq60').value = data.applied_profile.bass / 2 - 25;
                        }
                        if (data.applied_profile.mid !== undefined) {
                            updateEqualizer(1000, data.applied_profile.mid / 2 - 25);
                            document.getElementById('eq1000').value = data.applied_profile.mid / 2 - 25;
                        }
                        if (data.applied_profile.treble !== undefined) {
                            updateEqualizer(16000, data.applied_profile.treble / 2 - 25);
                            document.getElementById('eq16000').value = data.applied_profile.treble / 2 - 25;
                        }
                    }

                    localStorage.setItem('lastAppliedProfile', profileName);
                }
            } catch (error) {
                console.error("Error applying profile:", error)
            }
        }


        // Update exposure time display
        function updateExposureTimeDisplay() {
            const exposureTimeDisplay = document.getElementById("exposureTimeDisplay");
            if (exposureTimeDisplay) {
                const seconds = Math.floor(exposureTime / 1000);  // Convertir milisegundos a segundos
                exposureTimeDisplay.textContent = `Exposure Time: ${seconds} seconds`;
            } else {
                console.error('Element with ID "exposureTimeDisplay" not found');
            }
        }

        async function sendExposureTimeToServer() {
            const csrfToken = getCookie('csrftoken');
            console.log('exposureTime to send: ', exposureTime);
            const exposureTimeInMinutes = Math.floor(exposureTime / 60000);
            console.log('exposureTime minutos conversion: ', exposureTimeInMinutes);

            try {
                const response = await fetch('/save_exposure_time/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken,
                    },
                    body: JSON.stringify({
                        exposure_time: exposureTimeInMinutes,  // Asegúrate de que este valor sea correcto
                    }),
                });

                if (response.ok) {
                    console.log('Exposure time saved successfully');
                    console.log('Exposure time to send:', exposureTimeInMinutes);
                } else {
                    console.error('Failed to save exposure time');
                }
            } catch (error) {
                console.error('Error saving exposure time:', error);
            }
        }

        // Cargar perfiles al iniciar
        document.addEventListener("DOMContentLoaded", () => {
            if (typeof loadSoundProfiles === 'function') {
                loadSoundProfiles();
            } else {
                console.warn("⚠️ loadSoundProfiles is not defined.");
            }
        });

        // Dark mode toggle
        document.getElementById('darkModeToggle').addEventListener('click', () => {
            const isDark = document.documentElement.classList.toggle('dark');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
        });

        // Check for saved theme preference
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme === 'dark') {
            document.documentElement.classList.add('dark');
        }

        // Initialize equalizer display
        frequencies.forEach(freq => {
            updateEqualizer(freq, 0);
        });

        // Party Mode Functions
        async function createParty() {
            console.log("Create Party function triggered"); // Debug
            try {
                const csrfToken = getCookie('csrftoken');
                if (!csrfToken) {
                    console.error("CSRF token not found!");
                    return;
                }

                const response = await fetch('/party/create/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken,
                    },
                    credentials: 'include' // Importante para cookies
                });

                console.log("Response status:", response.status); // Debug

                const data = await response.json();
                console.log("Response data:", data); // Debug

                if (data.status === 'success') {
                    showNotification(`🎉 Party created! Code: ${data.session_code}`, 'success');
                    setTimeout(() => location.reload(), 1500); // Recarga después de 1.5 segundos
                } else {
                    showNotification(`Error: ${data.message || 'Unknown error'}`, 'error');
                }
            } catch (error) {
                console.error('Error creating party:', error);
                showNotification('⚠️ Failed to create party. Check console.', 'error');
            }
        }

        async function joinParty() {
            const code = document.getElementById('party-code').value.trim();
            if (!code) {
                showNotification('Please enter a party code', 'warning');
                return;
            }

            try {
                const response = await fetch('/party/join/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken'),
                    },
                    body: JSON.stringify({ session_code: code })
                });

                const data = await response.json();
                if (data.status === 'success') {
                    showNotification('🎧 Joined party!', 'success');
                    location.reload();
                } else {
                    showNotification(data.message || '❌ Invalid code', 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                showNotification('🚨 Connection error', 'error');
            }
        }

        async function leaveParty() {
            try {
                const response = await fetch('/party/leave/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    }
                });
                const data = await response.json();
                if (data.status === 'success') {
                    // Optionally clear the chat container
                    const chatContainer = document.getElementById('chat-container');
                    if (chatContainer) {
                        chatContainer.innerHTML = '';
                    }
                    // Clear the interval for fetching messages
                    clearInterval(messageInterval); // Assuming you store the interval ID
                    // Reload the page to reflect the change in party status
                    window.location.reload();
                } else {
                    console.error('Failed to leave party:', data.message);
                    // Optionally display an error message to the user
                }
            } catch (error) {
                console.error('Error leaving party:', error);
                // Optionally display an error message to the user
            }
        }
        async function fetchMessages() {
            try {
                const response = await fetch(`/party/chat/${'{{ user_prefs.current_party.id }}'}/`); // Replace with your URL
                const data = await response.json();
                if (data.status === 'success') {
                    const chatContainer = document.getElementById('chat-container');
                    chatContainer.innerHTML = ''; // Clear previous messages
                    data.messages.forEach(msg => {
                        const messageElement = document.createElement('div');
                        messageElement.innerHTML = `<strong>${msg.user}:</strong> ${msg.content}`;
                        chatContainer.appendChild(messageElement);
                    });
                    chatContainer.scrollTop = chatContainer.scrollHeight;  // Scroll to bottom
                } else {
                    console.error('Failed to fetch messages:', data.message);
                }
            } catch (error) {
                console.error('Error fetching messages:', error);
            }
        }

        // Function to send a new chat message
        async function sendMessage() {
            const input = document.getElementById('chat-message-input');
            const content = input.value.trim();
            if (content) {
                try {
                    const response = await fetch('/party/chat/send/', { // Replace with your URL
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCookie('csrftoken')  // Get CSRF token (see utility function below)
                        },
                        body: JSON.stringify({ content: content })
                    });
                    const data = await response.json();
                    if (data.status === 'success') {
                        input.value = '';  // Clear input
                        fetchMessages(); // Refresh messages
                    } else {
                        console.error('Failed to send message:', data.message);
                    }
                } catch (error) {
                    console.error('Error sending message:', error);
                }
            }
        }
        // Utility function to get CSRF token from cookies
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    let cookie = cookies[i].trim();
                    if (cookie.startsWith(name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // Fetch messages initially and then periodically
        // Store the interval ID so we can clear it later
        let messageInterval = setInterval(fetchMessages, 3000);
        fetchMessages();

    </script>

</body>

</html>